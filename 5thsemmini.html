<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOLAR POWERED COIN BASED MOBILE CHARGER SYSTEM</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
    }
    #sidebar {
      width: 300px;
      background: white;
      border-right: 1px solid #ddd;
      height: 100vh;
      overflow-y: auto;
      padding: 10px;
    }
    #map {
      flex: 1;
      height: 100vh;
    }
    h1 {
      font-size: 18px;
      margin: 10px 0;
      color: #2c3e50;
      text-align: center;
    }
    .station-item {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      margin: 8px 0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .station-item:hover {
      background: #f0f8ff;
    }
    .station-distance {
      font-size: 14px;
      color: #555;
    }
    .search-container {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    #location-input {
      flex: 1;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .btn {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: white;
    }
    .btn-primary { background: #3498db; }
    .btn-current { background: #2ecc71; }
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 10px;
      display: none;
      z-index: 1000;
      text-align: center;
    }
    .spinner {
      width: 40px;
      height: 40px;
      margin: 10px auto;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); } 
    }
    .error-message {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #ff5252;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h1><i class="fas fa-solar-panel"></i> Solar Coin Chargers</h1>
    <div class="search-container">
      <input type="text" id="location-input" placeholder="Enter location" onkeypress="handleKeyPress(event)">
      <button class="btn btn-primary" onclick="searchLocation()">Go</button>
      <button class="btn btn-current" onclick="useCurrentLocation()">üìç</button>
    </div>
    <div id="station-list">No stations loaded yet.</div>
  </div>
  <div id="map"></div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p id="loading-text">Loading...</p>
  </div>
  <div id="error-message" class="error-message"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map, markers = L.layerGroup(), userLocation = null, stationsData = [];

    function initMap() {
      map = L.map('map').setView([20.5937, 78.9629], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);
      markers.addTo(map);
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                Math.sin(dLon/2)**2;
      return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(2);
    }

    function searchEVStations(location) {
      markers.clearLayers();
      stationsData = [];
      showLoading("Searching chargers...");

      const query = `[out:json][timeout:25];
      (
        node["amenity"="charging_station"]["fuel:solar"="yes"]["payment:coins"="yes"](around:3000,${location.lat},${location.lng});
        way["amenity"="charging_station"]["fuel:solar"="yes"]["payment:coins"="yes"](around:3000,${location.lat},${location.lng});
      );
      out body; >; out center qt;`;

      fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: `data=${encodeURIComponent(query)}`,
        headers: { "Content-Type": "application/x-www-form-urlencoded" }
      })
      .then(res => res.json())
      .then(data => {
        if (!data.elements || data.elements.length === 0) {
          showError("No real chargers found. Showing virtual demo.");
          addVirtualStations();
        } else {
          data.elements.forEach(st => addStation(st));
        }
        hideLoading();
        renderStationList();
      })
      .catch(() => {
        showError("Error fetching chargers. Showing virtual demo.");
        addVirtualStations();
        hideLoading();
        renderStationList();
      });
    }

    function addStation(station, isVirtual=false) {
      const lat = station.lat || (station.center && station.center.lat);
      const lon = station.lon || (station.center && station.center.lon);
      if (!lat || !lon) return;

      let distance = "";
      if (userLocation) distance = getDistance(userLocation.lat, userLocation.lng, lat, lon);

      const data = {
        lat, lon,
        name: station.tags?.name || station.name || "Unnamed Station",
        operator: station.tags?.operator || station.operator || "Unknown",
        distance, isVirtual
      };
      stationsData.push(data);

      const marker = L.marker([lat, lon], {
        icon: L.icon({
          iconUrl: isVirtual 
            ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png'
            : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
          iconSize: [25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
        })
      }).bindPopup(`
        <h3>${isVirtual ? "Virtual " : ""}Solar Coin Charger</h3>
        <p><b>Name:</b> ${data.name}</p>
        <p><b>Operator:</b> ${data.operator}</p>
        <p><b>Payment:</b> Coins</p>
        <p><b>Energy:</b> Solar</p>
        ${distance ? `<p><b>Distance:</b> ${distance} km</p>` : ""}
      `);
      markers.addLayer(marker);
    }

    function addVirtualStations() {
      const demo = [
        {lat:15.8497, lon:74.4977, name:"Belgaum Solar Coin Charger", operator:"Demo Operator"},
        {lat:15.8645, lon:74.5089, name:"Bus Stand Solar Charger", operator:"KSRTC"},
        {lat:15.8700, lon:74.5200, name:"College Campus Solar Charger", operator:"Jain College"},

        // ‚úÖ New Hubli demo stations
        {lat:15.3647, lon:75.1240, name:"Hubli Railway Station Solar Charger", operator:"IRCTC"},
        {lat:15.3615, lon:75.1376, name:"Hubli Central Bus Stand Solar Charger", operator:"NWKRTC"},
        {lat:15.3500, lon:75.1400, name:"Hubli University Campus Solar Charger", operator:"Karnataka University"}
      ];
      demo.forEach(st => addStation(st, true));
    }

    function renderStationList() {
      const list = document.getElementById("station-list");
      if (stationsData.length === 0) {
        list.innerHTML = "<p>No stations available.</p>";
        return;
      }
      // Sort by distance
      stationsData.sort((a, b) => parseFloat(a.distance || 9999) - parseFloat(b.distance || 9999));
      list.innerHTML = "";
      stationsData.forEach((st, i) => {
        const div = document.createElement("div");
        div.className = "station-item";
        div.innerHTML = `
          <b>${st.name}</b><br>
          <span class="station-distance">${st.distance ? st.distance+" km" : "Distance N/A"}</span>
        `;
        div.onclick = () => {
          map.setView([st.lat, st.lon], 16);
        };
        list.appendChild(div);
      });
    }

    function searchLocation() {
      const query = document.getElementById("location-input").value;
      if (!query) return showError("Enter a location.");
      showLoading("Finding location...");
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            const loc = {lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon)};
            userLocation = loc;
            map.setView([loc.lat, loc.lng], 14);
            searchEVStations(loc);
          } else {
            hideLoading(); showError("Location not found.");
          }
        })
        .catch(()=>{hideLoading(); showError("Error finding location.");});
    }

    function useCurrentLocation() {
      showLoading("Getting location...");
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const loc = {lat: pos.coords.latitude, lng: pos.coords.longitude};
          userLocation = loc;
          map.setView([loc.lat, loc.lng], 14);
          searchEVStations(loc);
        }, ()=>{hideLoading(); showError("Could not get location."); addVirtualStations(); renderStationList();});
      } else {
        hideLoading(); showError("Geolocation not supported."); addVirtualStations(); renderStationList();
      }
    }

    function handleKeyPress(e) { if (e.key==="Enter") searchLocation(); }

    function showLoading(msg) {
      document.getElementById("loading-text").textContent = msg;
      document.getElementById("loading").style.display = "block";
    }
    function hideLoading() { document.getElementById("loading").style.display = "none"; }
    function showError(msg) {
      const err = document.getElementById("error-message");
      err.textContent = msg; err.style.display = "block";
      setTimeout(()=> err.style.display="none",3000);
    }

    window.onload = initMap;
  </script>
</body>
</html>
